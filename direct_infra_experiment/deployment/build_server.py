#!/usr/bin/env python3
"""
NormCode Deployment Server Build Script

Creates a self-contained deployment server package with everything needed to run.

Usage:
    python build_server.py                      # Build to ./dist/normcode-server/
    python build_server.py -o ./my-server       # Custom output directory
    python build_server.py --include-test-plans # Include test plans
    python build_server.py --zip                # Also create a zip archive

Output structure:
    normcode-server/
    ├── server.py              # Main entry point
    ├── runner.py              # Plan runner
    ├── tools/                 # Deployment tools
    ├── infra/                 # Core NormCode library
    ├── mock_users/            # Test clients (CLI and GUI)
    ├── data/
    │   ├── plans/             # Deploy plans here
    │   ├── runs/              # Run data stored here
    │   └── config/            # Server configuration
    │       └── settings.yaml  # LLM settings
    ├── requirements.txt       # Python dependencies
    ├── start_server.py        # Simple start script
    └── README.md              # Usage instructions
"""

import sys
import shutil
import argparse
import json
from pathlib import Path
from datetime import datetime

# Paths
SCRIPT_DIR = Path(__file__).resolve().parent
PROJECT_ROOT = SCRIPT_DIR.parent
DEPLOY_OPERATORS_DIR = SCRIPT_DIR / "deploy_operators"
TOOLS_DIR = SCRIPT_DIR / "tools"
INFRA_DIR = PROJECT_ROOT / "infra"
MOCK_USERS_DIR = SCRIPT_DIR / "mock_users"


def copy_directory(src: Path, dst: Path, exclude_patterns: list = None):
    """Copy a directory, excluding certain patterns."""
    exclude_patterns = exclude_patterns or []
    
    def should_exclude(path: Path) -> bool:
        name = path.name
        for pattern in exclude_patterns:
            if pattern in str(path) or name == pattern:
                return True
        return False
    
    if dst.exists():
        shutil.rmtree(dst)
    
    def copy_tree(src_dir: Path, dst_dir: Path):
        dst_dir.mkdir(parents=True, exist_ok=True)
        for item in src_dir.iterdir():
            if should_exclude(item):
                continue
            dst_item = dst_dir / item.name
            if item.is_dir():
                copy_tree(item, dst_item)
            else:
                shutil.copy2(item, dst_item)
    
    copy_tree(src, dst)


def write_text_utf8(path: Path, content: str):
    """Write text to file with UTF-8 encoding (Windows compatible)."""
    with open(path, 'w', encoding='utf-8') as f:
        f.write(content)


def create_requirements(output_dir: Path):
    """Create requirements.txt with necessary dependencies."""
    requirements = """# NormCode Deployment Server Requirements
# Generated by build_server.py

# Web framework
fastapi>=0.100.0
uvicorn>=0.22.0
python-multipart>=0.0.6

# LLM providers
openai>=1.0.0
dashscope>=1.14.0
anthropic>=0.18.0

# Utilities
pyyaml>=6.0
pydantic>=2.0.0
numpy>=1.24.0

# Optional: for development
# httpx>=0.24.0
"""
    write_text_utf8(output_dir / "requirements.txt", requirements)


def create_start_script(output_dir: Path):
    """Create a simple start script."""
    script = '''#!/usr/bin/env python3
"""
Start the NormCode Deployment Server.

Usage:
    python start_server.py
    python start_server.py --port 9000
    python start_server.py --host 127.0.0.1 --port 8080
"""

import sys
import os
from pathlib import Path

# Add current directory to path
SERVER_DIR = Path(__file__).resolve().parent
sys.path.insert(0, str(SERVER_DIR))

# Set default data directories
os.environ.setdefault("NORMCODE_PLANS_DIR", str(SERVER_DIR / "data" / "plans"))
os.environ.setdefault("NORMCODE_RUNS_DIR", str(SERVER_DIR / "data" / "runs"))

# Import and run
from server import main

if __name__ == "__main__":
    main()
'''
    start_script = output_dir / "start_server.py"
    write_text_utf8(start_script, script)
    # Make executable on Unix
    try:
        start_script.chmod(0o755)
    except:
        pass


def create_readme(output_dir: Path):
    """Create README with usage instructions."""
    readme = f'''# NormCode Deployment Server

A self-contained server for executing NormCode plans.

Built: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}

## Quick Start

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

2. Configure LLM settings (optional):
   Edit `data/config/settings.yaml` with your API keys.

3. Start the server:
   ```bash
   python start_server.py
   ```
   Or with options:
   ```bash
   python start_server.py --port 9000 --host 0.0.0.0
   ```

4. Access the API:
   - Health check: http://localhost:8080/health
   - API docs: http://localhost:8080/docs
   - Server info: http://localhost:8080/info

## Directory Structure

```
normcode-server/
├── start_server.py     # Start script
├── server.py           # Main server code
├── runner.py           # Plan execution
├── tools/              # Deployment tools
├── infra/              # Core NormCode library
├── mock_users/         # Test clients
│   ├── client.py       # CLI test client
│   └── client_gui.py   # GUI test client
├── data/
│   ├── plans/          # Deploy plans here
│   ├── runs/           # Run data (auto-created)
│   └── config/
│       └── settings.yaml  # LLM configuration
└── requirements.txt
```

## Test Clients

The `mock_users/` directory contains test clients:

```bash
# CLI client
python mock_users/client.py --server http://localhost:8080

# GUI client (requires tkinter)
python mock_users/client_gui.py
```

## API Endpoints

### Plans
- `GET /api/plans` - List deployed plans
- `GET /api/plans/{{plan_id}}` - Get plan details
- `POST /api/plans/deploy-file` - Deploy a plan (zip upload)
- `DELETE /api/plans/{{plan_id}}` - Remove a plan
- `DELETE /api/plans` - Remove ALL plans

### Runs
- `POST /api/runs` - Start a new run
- `GET /api/runs` - List all runs
- `GET /api/runs/{{run_id}}` - Get run status
- `GET /api/runs/{{run_id}}/result` - Get run result
- `DELETE /api/runs` - Remove ALL runs

### Server
- `GET /health` - Health check
- `GET /info` - Server information
- `GET /api/models` - Available LLM models
- `POST /api/server/reset` - Full server reset

## Deploying Plans

### Option 1: HTTP Upload
```bash
curl -X POST http://localhost:8080/api/plans/deploy-file \\
  -F "plan=@my-plan.zip"
```

### Option 2: Direct Copy
Copy your plan folder directly to `data/plans/`:
```bash
cp -r ./my-plan/ ./data/plans/my-plan/
```

## Running Plans

```bash
curl -X POST http://localhost:8080/api/runs \\
  -H "Content-Type: application/json" \\
  -d '{{"plan_id": "my-plan", "llm_model": "qwen-plus"}}'
```

## LLM Configuration

Edit `data/config/settings.yaml`:

```yaml
BASE_URL: https://dashscope.aliyuncs.com/compatible-mode/v1

qwen-plus:
  model: qwen-plus
  api_key: your-api-key-here

gpt-4o:
  model: gpt-4o
  api_key: your-openai-key
  base_url: https://api.openai.com/v1
```

## License

Part of the NormCode project.
'''
    write_text_utf8(output_dir / "README.md", readme)


def create_default_settings(output_dir: Path):
    """Create default LLM settings file."""
    settings = '''# NormCode LLM Settings
# Configure your LLM providers here

# Default base URL (for DashScope/Qwen)
BASE_URL: https://dashscope.aliyuncs.com/compatible-mode/v1

# Qwen models (via DashScope)
qwen-plus:
  model: qwen-plus
  api_key: YOUR_DASHSCOPE_API_KEY_HERE

qwen-turbo:
  model: qwen-turbo
  api_key: YOUR_DASHSCOPE_API_KEY_HERE

# OpenAI models
# gpt-4o:
#   model: gpt-4o
#   api_key: YOUR_OPENAI_API_KEY
#   base_url: https://api.openai.com/v1

# Anthropic models
# claude-sonnet:
#   model: claude-3-sonnet-20240229
#   api_key: YOUR_ANTHROPIC_API_KEY
#   base_url: https://api.anthropic.com

# Demo mode (no API calls, returns mock responses)
demo:
  model: demo
  api_key: mock
'''
    config_dir = output_dir / "data" / "config"
    config_dir.mkdir(parents=True, exist_ok=True)
    write_text_utf8(config_dir / "settings.yaml", settings)


def build_server(
    output_dir: Path,
    include_test_plans: bool = False,
    create_zip: bool = False
):
    """Build the deployment server package."""
    print(f"Building NormCode Deployment Server...")
    print(f"  Output: {output_dir}")
    
    # Clean output directory
    if output_dir.exists():
        print(f"  Cleaning existing output directory...")
        shutil.rmtree(output_dir)
    output_dir.mkdir(parents=True)
    
    # 1. Copy deploy_operators (server.py, runner.py)
    print(f"  Copying server files...")
    for py_file in DEPLOY_OPERATORS_DIR.glob("*.py"):
        if py_file.name != "__init__.py":
            shutil.copy2(py_file, output_dir / py_file.name)
    
    # Copy settings.yaml if exists
    settings_src = DEPLOY_OPERATORS_DIR / "settings.yaml"
    if settings_src.exists():
        config_dir = output_dir / "data" / "config"
        config_dir.mkdir(parents=True, exist_ok=True)
        shutil.copy2(settings_src, config_dir / "settings.yaml")
    else:
        create_default_settings(output_dir)
    
    # 2. Copy tools directory
    print(f"  Copying deployment tools...")
    copy_directory(
        TOOLS_DIR,
        output_dir / "tools",
        exclude_patterns=["__pycache__", ".pyc", "__init__.py"]
    )
    # Create __init__.py for tools
    write_text_utf8(output_dir / "tools" / "__init__.py", "# Deployment tools\n")
    
    # 3. Copy infra directory
    print(f"  Copying infra library...")
    copy_directory(
        INFRA_DIR,
        output_dir / "infra",
        exclude_patterns=["__pycache__", ".pyc", "*.egg-info", ".pytest_cache"]
    )
    
    # 4. Copy mock_users for testing
    if MOCK_USERS_DIR.exists():
        print(f"  Copying mock_users (test clients)...")
        copy_directory(
            MOCK_USERS_DIR,
            output_dir / "mock_users",
            exclude_patterns=["__pycache__", ".pyc"]
        )
        # Create __init__.py for mock_users
        write_text_utf8(output_dir / "mock_users" / "__init__.py", "# Mock user clients for testing\n")
    
    # 5. Create data directories
    print(f"  Creating data directories...")
    (output_dir / "data" / "plans").mkdir(parents=True, exist_ok=True)
    (output_dir / "data" / "runs").mkdir(parents=True, exist_ok=True)
    
    # 6. Include test plans if requested
    if include_test_plans:
        print(f"  Including test plans...")
        test_plans_src = SCRIPT_DIR / "test_ncs" / "pre-deployment"
        if test_plans_src.exists():
            for plan_dir in test_plans_src.iterdir():
                if plan_dir.is_dir() and (plan_dir / "manifest.json").exists():
                    copy_directory(
                        plan_dir,
                        output_dir / "data" / "plans" / plan_dir.name,
                        exclude_patterns=["__pycache__", ".pyc", "runs", "logs"]
                    )
                    print(f"    Added: {plan_dir.name}")
    
    # 7. Create requirements.txt
    print(f"  Creating requirements.txt...")
    create_requirements(output_dir)
    
    # 8. Create start script
    print(f"  Creating start script...")
    create_start_script(output_dir)
    
    # 9. Create README
    print(f"  Creating README...")
    create_readme(output_dir)
    
    # 10. Create zip if requested
    if create_zip:
        print(f"  Creating zip archive...")
        zip_path = output_dir.parent / f"{output_dir.name}.zip"
        shutil.make_archive(
            str(output_dir),
            'zip',
            output_dir.parent,
            output_dir.name
        )
        print(f"  Created: {zip_path}")
    
    print(f"\n[OK] Build complete!")
    print(f"\nTo run the server:")
    print(f"  cd {output_dir}")
    print(f"  pip install -r requirements.txt")
    print(f"  python start_server.py")
    
    return output_dir


def main():
    parser = argparse.ArgumentParser(
        description="Build NormCode Deployment Server package",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python build_server.py
  python build_server.py -o ./my-server
  python build_server.py --include-test-plans --zip
        """
    )
    
    parser.add_argument(
        "-o", "--output",
        type=Path,
        default=SCRIPT_DIR / "dist" / "normcode-server",
        help="Output directory (default: ./dist/normcode-server/)"
    )
    parser.add_argument(
        "--include-test-plans",
        action="store_true",
        help="Include test plans from pre-deployment"
    )
    parser.add_argument(
        "--zip",
        action="store_true",
        help="Also create a zip archive"
    )
    
    args = parser.parse_args()
    
    build_server(
        output_dir=args.output.resolve(),
        include_test_plans=args.include_test_plans,
        create_zip=args.zip
    )


if __name__ == "__main__":
    main()

