# Step 4.2: Automated Prompt Generation

**Objective:** To assemble the final, executable prompt files by combining the specific context required for each prompt-driven inference. This is a deterministic assembly step, not an LLM generation step.

**Process:**

This step is an automated script that takes one key input:

1.  **The final Context Manifest (`4.1_context_manifest.json`):** This file provides the complete mapping between each prompt and its required context files.

The script performs the following actions:

1.  **Reads the Manifest:** It parses the `4.1_context_manifest.json` file.
2.  **Iterates Through Prompts:** It loops through each key-value pair in the `context_mapping` object. Each key represents a unique prompt file to be generated.
3.  **Assembles Content:** For each prompt, it reads the array of file paths from the `context_files` field. It then opens and concatenates the content of each of these files in the specified order. The general convention is to list shared context files first, followed by more specific, step-related files.
4.  **Writes Prompt Files:** The concatenated content is written to a new file within the `prompts/` directory. The name of the file is taken directly from the key in the manifest (e.g., `[1.2.2.2.]1.1_instruction_distillation.md`).

---

### Example Walkthrough

This example demonstrates how a single prompt file is assembled.

**1. Input (`4.1_context_manifest.json` snippet):**

The manifest provides the "recipe" for building the prompt.

```json
{
  "context_mapping": {
    "[1.2.2.2.]1.1_instruction_distillation.md": {
      "used_by_inference": "1.2.2.1.imperative|<= ::{%(direct)}(...)",
      "context_files": [
        "./context_store/shared---pipeline_goal_and_structure.md",
        "./context_store/1.2.2.1---automated_instruction_distillation.md"
      ]
    },
    // ... other prompt mappings
  }
}
```

**2. Assembly Process:**

The script identifies the entry for `[1.2.2.2.]1.1_instruction_distillation.md`. It then:
1.  Reads the content of `./context_store/shared---pipeline_goal_and_structure.md`.
2.  Reads the content of `./context_store/1.2.2.1---automated_instruction_distillation.md`.
3.  Concatenates these two pieces of content together.
4.  Creates a new file named `prompts/[1.2.2.2.]1.1_instruction_distillation.md`.
5.  Writes the concatenated content into this new file.

**3. Output (A new file in `prompts/`):**

The result is a complete, self-contained prompt file ready to be used by the corresponding imperative (`1.2.2.1.imperative`). The content of `prompts/[1.2.2.2.]1.1_instruction_distillation.md` would look like this:

```markdown
<Content of shared---pipeline_goal_and_structure.md>
---
<Content of 1.2.2.1---automated_instruction_distillation.md>
```

This process is repeated for every entry in the manifest, resulting in a fully populated `prompts/` directory.

---
# File Format: Prompt Files (`.md`)

The prompt files, located in the `prompts/` directory, are the final, assembled instructions ready to be sent to an AI model. Each file is generated during Phase 4 of the pipeline by combining a task-specific prompt with the precise context it needs.

**Purpose:**
These files represent the fully contextualized, executable version of each imperative step in the NormCode plan. The generation of these files is the primary goal of the contextualization phase, ensuring that every action taken by the AI is guided by a clear instruction and the necessary supporting information.

**Format:**
The prompt files are Markdown (`.md`) files. Their content is dynamically generated by concatenating two types of files:

1.  **A Base Prompt**: The core instruction for the task, often named with a `flow_index` that ties it to the `.nc` plan (e.g., `1.2.2.2.1.1_instruction_distillation.md`).
2.  **Context Files**: A set of files from the `context_store` directory, as specified for that prompt in the `context_manifest.json`.

**Naming Convention:**
The generated prompts are typically named using the `flow_index` and a descriptive title from the corresponding prompt object in the `.nc` file, for example: `[1.2.2.2.]1.1_instruction_distillation.md`. This ensures that each generated prompt is traceable back to its origin in the formal plan.

---
# File Format: Context Manifest (`.json`)

The `context_manifest.json` file is a critical artifact generated during Phase 4 (Contextualization). It acts as a map, linking each prompt in the plan to both its required context files and the specific inference that uses it.

**Purpose:**
The manifest's primary role is to provide the precise list of context files needed to assemble each prompt. By also including a reference to the inference that consumes the prompt, it creates a fully traceable link between a high-level action, its instruction (the prompt), and its knowledge base (the context). This ensures every step is minimal, complete, and auditable.

**Format:**
The manifest is a JSON object. Each key uniquely identifies a prompt, and the corresponding value is an object containing details about its usage.

-   **Key**: `"[flow_index]prompt_filename.md"`
    -   `flow_index`: The unique, dot-delimited index of the prompt object from the `.nc` file (e.g., `1.2.2.2.`).
    -   `prompt_filename.md`: The filename of the prompt, as specified in the `%{prompt_location}` annotation.
-   **Value**: An object with two fields:
    -   `used_by_inference`: A string containing the full line of the inference from the `.nc` file that uses this prompt.
    -   `context_files`: An array of strings, where each string is a path to a required context file.

**Example Snippet:**
```json
{
  "[1.2.2.2.]1.1_instruction_distillation.md": {
    "used_by_inference": "1.2.2.1.imperative|<= ::{%(direct)}({prompt}<$({instruction distillation prompt})%>: {1}<$({input files})%>)",
    "context_files": [
      "./context_store/1.2.2.1---automated_instruction_distillation.md",
      "./context_store/shared---pipeline_goal_and_structure.md"
    ]
  },
  "[1.2.3.2.]1.2_context_registration.md": {
    "used_by_inference": "1.2.3.1.imperative|<= ::{%(direct)}({prompt}<$({context registration prompt})%>: {1}<$({input files})%>)",
    "context_files": [
      "./context_store/1.2.3.1---automated_context_registration.md",
      "./context_store/shared---pipeline_goal_and_structure.md"
    ]
  }
}
```
This structure provides a clear, machine-readable, and highly traceable map for the prompt assembly process.

---
