{
  "metadata": {
    "description": "Takes a memo (user message) and uses an LLM with a prompt template to parse it as a command. Returns a structured command object.",
    "inputs": {
      "vertical": {
        "prompt_template": "The prompt template file path (from function concept reference, may be perception-wrapped)."
      },
      "horizontal": {
        "input_1": "The user message (memo) to classify.",
        "input_2": "The command schema for reference."
      }
    },
    "outputs": {
      "type": "Command",
      "description": "A dict with 'type', 'params', 'confidence', and 'reasoning' fields."
    }
  },
  "env_spec": {
    "tools": [
      {
        "tool_name": "llm",
        "affordances": [
          {
            "affordance_name": "generate",
            "call_code": "result = tool.generate"
          }
        ]
      },
      {
        "tool_name": "composition_tool",
        "affordances": [
          {
            "affordance_name": "compose",
            "call_code": "result = tool.compose(plan=params['plan'], return_key=params.get('return_key'))"
          }
        ]
      },
      {
        "tool_name": "formatter_tool",
        "affordances": [
          {
            "affordance_name": "parse",
            "call_code": "result = tool.parse"
          },
          {
            "affordance_name": "wrap",
            "call_code": "result = tool.wrap"
          },
          {
            "affordance_name": "clean_code",
            "call_code": "result = tool.clean_code"
          }
        ]
      },
      {
        "tool_name": "prompt_tool",
        "affordances": [
          {
            "affordance_name": "read_now",
            "call_code": "result = tool.read(params['template_name'])"
          },
          {
            "affordance_name": "create_template_function",
            "call_code": "result = tool.create_template_function(template=params['template'])"
          }
        ]
      },
      {
        "tool_name": "perception_router",
        "affordances": [
          {
            "affordance_name": "strip_sign",
            "call_code": "result = tool.strip_sign(params['token'])"
          }
        ]
      }
    ]
  },
  "sequence_spec": {
    "steps": [
      {
        "step_index": 1,
        "affordance": "perception_router.strip_sign",
        "params": {
          "token": {
            "__type__": "MetaValue",
            "key": "states.vertical"
          }
        },
        "result_key": "raw_path"
      },
      {
        "step_index": 2,
        "affordance": "prompt_tool.read_now",
        "params": {
          "template_name": {
            "__type__": "MetaValue",
            "key": "raw_path"
          }
        },
        "result_key": "prompt_obj"
      },
      {
        "step_index": 3,
        "affordance": "prompt_tool.create_template_function",
        "params": {
          "template": {
            "__type__": "MetaValue",
            "key": "prompt_obj"
          }
        },
        "result_key": "template_fn"
      },
      {
        "step_index": 4,
        "affordance": "llm.generate",
        "params": {},
        "result_key": "generate_fn"
      },
      {
        "step_index": 5,
        "affordance": "formatter_tool.clean_code",
        "params": {},
        "result_key": "clean_code_fn"
      },
      {
        "step_index": 6,
        "affordance": "formatter_tool.parse",
        "params": {},
        "result_key": "parse_fn"
      },
      {
        "step_index": 7,
        "affordance": "formatter_tool.wrap",
        "params": {},
        "result_key": "wrap_fn"
      },
      {
        "step_index": 8,
        "affordance": "composition_tool.compose",
        "params": {
          "plan": [
            {
              "output_key": "prompt_string",
              "function": {
                "__type__": "MetaValue",
                "key": "template_fn"
              },
              "params": {
                "__positional__": "__initial_input__"
              }
            },
            {
              "output_key": "raw_llm_response",
              "function": {
                "__type__": "MetaValue",
                "key": "generate_fn"
              },
              "params": {
                "__positional__": "prompt_string"
              }
            },
            {
              "output_key": "cleaned_response",
              "function": {
                "__type__": "MetaValue",
                "key": "clean_code_fn"
              },
              "params": {
                "__positional__": "raw_llm_response"
              }
            },
            {
              "output_key": "parsed_command",
              "function": {
                "__type__": "MetaValue",
                "key": "parse_fn"
              },
              "params": {
                "__positional__": "cleaned_response"
              }
            },
            {
              "output_key": "wrapped_command",
              "function": {
                "__type__": "MetaValue",
                "key": "wrap_fn"
              },
              "params": {
                "__positional__": "parsed_command"
              },
              "literal_params": {
                "type": "literal"
              }
            }
          ],
          "return_key": "wrapped_command"
        },
        "result_key": "instruction_fn"
      }
    ]
  }
}
